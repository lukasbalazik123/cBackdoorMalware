# cBackdoorMalware

example backdoor malware in C explained

Malware is written in C supporting __STRICT_ANSI__ so it can be compiled by movcc: https://github.com/xoreaxeaxeax/movfuscator

## Antidebuging

Malware contain 3 functions named with false name, so we can make it harder to read from symbols:

```c
int _memset();
int _sprintf();
int _strncpy();
```

​	Function **_memset** forks and check ptrace if we are traced we exit. SO engineer have to rewrite value before variable control is done 

​	Function **_sprintf** counts 0xcc in self (binary). 0xcc is opcode of INT3 which is used for software breakpoints, return of this function can be used in calculation data in deobfucation or comparing start breakpoints with breakpoints in middle (in this case we can assume debbuger was connected). In our case we calculate IP deobfucation by initial_brk which is_sprintf return. Be carefull in our case we use only **...0x33333333)))*(initial_brk);** but that is becouse we contain one 0xcc in our binary (can be found via **objdump -d | grep " cc"**). This 0xcc is valid part of instruction so we can assume that if initial_brk is > 1 we have breakpoints. The count of valid 0xcc in binary can change depends on code.

​	Function **_strncpy** checks /proce/self/status for TracerPid, based on this if is different than 0 we exit program, this way its hard for engineer to debug, either he have to modify /proces/self/status or have to change return value before function exit()

## Malware Flow

​	When malware is started, deobfucation of harcoded ip and port begins. If everything is okay we connect to C&C server and send him information about us:
sprintf(access_key, "%d_G_%d", key_part, actual_brk);
under this information we can find output of malware on C&C server.  Then malware starts reading commands from C&C server and use popen on them.

## Weak places

​	One of the most weakest places is that we control only software breakpoints, so as reverse engineer we can use hardware breakpoints and we can bypass our security created by **_sprintf**. 
​	We dont use timebased antidebug functions which would control time between executed instruction (if we set breakpoint in between the speed of instruction execution will be a lot different).

## Compilation and Usage

obfuscate_ip_and_port - our tool for obfuscate ip and port so we can use it in malware code

```sh 
$ gcc -o obfuscate obfuscate_ip_and_port.c 
$ ./obfuscate <IP> <PORT>
```
then add IP to variable y and PORT to defined PORT in malware.c and compile

``` movcc malware.c -o malware```

